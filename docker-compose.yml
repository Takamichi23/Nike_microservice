services:
  # FastAPI Backend Service
  fastapi:
    build:
      context: .
      dockerfile: fastapi_app/Dockerfile
    container_name: nike_fastapi
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - ENV=production
      - PYTHONUNBUFFERED=1
    volumes:
      # Mount database file to persist data (shared with Django)
      - ./db.sqlite3:/app/db.sqlite3:rw
      # Optional: mount code for development (comment out in production)
      # - ./fastapi_app:/app/fastapi_app:ro
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:8000/health\").read()' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - nike_network

  # Django Frontend Service
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: nike_frontend
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      - DEBUG=False
      - ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0,frontend
      - FASTAPI_BASE_URL=http://fastapi:8000
      - PYTHONUNBUFFERED=1
      - DJANGO_SETTINGS_MODULE=ecom.settings
    volumes:
      # Mount database file to persist data (shared with FastAPI)
      - ./db.sqlite3:/app/db.sqlite3:rw
      # Mount media files
      - ./media:/app/media:rw
      # Optional: mount code for development (comment out in production)
      # - .:/app:ro
    depends_on:
      fastapi:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:8001\").read()' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - nike_network

networks:
  nike_network:
    driver: bridge

